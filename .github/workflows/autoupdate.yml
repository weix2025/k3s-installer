name: Full Registry Mirror Health Check

on:
  schedule:
    # 北京时间每周日凌晨 08:00 运行 (UTC 00:00)
    - cron: '0 0 */7 * *'
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Backup and Verify All Sources
        run: |
          # 动态获取当前仓库所有 txt 文件
          FILES=$(ls *.txt)
          
          for file in $FILES; do
            # 忽略备份文件自身
            [[ "$file" == *.bak ]] && continue
            
            echo "--- 处理镜像源: $file ---"
            
            # 1. 创建备份
            cp "$file" "${file}.bak"
            
            # 2. 准备检测环境
            temp_file="${file}.valid"
            touch "$temp_result"

            # 3. 逐行并发检测 (为了加快 Action 速度)
            while read -r url || [ -n "$url" ]; do
              [[ -z "$url" || "$url" =~ ^# ]] && continue
              url=$(echo "$url" | xargs)
              
              # 检测存活性
              if curl -I -sL --connect-timeout 5 "https://$url/v2/" | grep -qE "200|301|302|401"; then
                echo "$url" >> "$temp_file"
                echo " [OK] $url"
              else
                echo " [FAIL] $url - 移至备份"
              fi
            done < "$file"

            # 4. 更新主列表
            mv "$temp_file" "$file"
          done

      - name: Commit and Push Changes
        run: |
          git config --local user.email "bot@mirror.check"
          git config --local user.name "Mirror-Health-Bot"
          git add *.txt *.bak
          
          if [[ -n $(git status -s) ]]; then
            git commit -m "chore: $(date '+%Y-%m-%d') 全源定期更新 (含备份更新)"
            git push
          else
            echo "源站状态稳定，无需变更。"
          fi
